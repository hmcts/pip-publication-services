#!groovy

@Library("Infrastructure")

def type = "java"
def product = "pip"
def component = "publication-services"

def setupTestSecrets() {
  def bootstap_env = env.ENV == "prod" || env.ENV == "demo" || env.ENV == "sbox" ? env.ENV : "stg"
  azureKeyVault(
    keyVaultURL: "https://pip-bootstrap-${bootstap_env}-kv.vault.azure.net/",
    secrets: [
      secret('gov-uk-notify-api-key', 'NOTIFY_API_KEY')
    ]) {
    env.NOTIFY_API_KEY = "${NOTIFY_API_KEY}"
  }
}

//def apiSecrets = [ 'pip-ss-kv-${env}' : [
//    secret('gov-uk-notify-api-key', 'NOTIFY_API_KEY')
//  ]
//]
static Map<String, Object> secret(String secretName, String envVariable) {
  [$class     : 'AzureKeyVaultSecret',
   secretType : 'Secret',
   name       : secretName,
   envVariable: envVariable
  ]
}

withPipeline(type, product, component) {

//  loadVaultSecrets(apiSecrets)

  onMaster() {
    env.ENV = 'stg'
  }
  onPR() {
    env.ENV = 'dev'
  }
  onDemo {
    env.ENV = 'demo'
  }
  onPerftest {
    env.ENV = 'perftest'
  }
  onIthc {
    env.ENV = 'ithc'
  }
  setupTestSecrets()
  enableSlackNotifications('#pip-build-notices')
  enableAksStagingDeployment()
  disableLegacyDeployment()
  enableApiGatewayTest()
}
